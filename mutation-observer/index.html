<!DOCTYPE html><html lang="ru"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description"><title>Опции MutationObserver в правильном порядке | Разработка всего</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="/css/highlight.css?v=0.0.0"><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"><link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=PT+Sans|PT+Sans+Narrow:400,700|PT+Sans+Caption"><link href='' rel='stylesheet' type='text/css'></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">Опции MutationObserver в правильном порядке</h1><a id="logo" href="/.">Разработка всего</a><p class="description"></p></div></div><div id="layout" class="pure-g"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">Опции MutationObserver в правильном порядке</h1><div class="post-content"><p>Дополнение к <a href="https://developer.mozilla.org/en/docs/Web/API/MutationObserver" target="_blank" rel="external">MDN/Web APIs/MutationObserver</a> о событиях изменения DOM с различными конфигурациями наблюдателя.</p>
<h4 id="Элементарный-пример"><a href="#Элементарный-пример" class="headerlink" title="Элементарный пример"></a>Элементарный пример</h4><p>Наблюдаются все элементы и атрибуты:<br><figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"root"</span> <span class="attr">data-custom-attribute</span>=<span class="string">"Root attribute"</span>&gt;</span></div><div class="line">  Root text</div><div class="line">  <span class="tag">&lt;<span class="name">ul</span> <span class="attr">class</span>=<span class="string">"parent"</span> <span class="attr">data-custom-attribute</span>=<span class="string">"Parent attribute"</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">li</span> <span class="attr">class</span>=<span class="string">"child"</span> <span class="attr">data-custom-attribute</span>=<span class="string">"Child attribute"</span> <span class="attr">contenteditable</span>=<span class="string">"true"</span>&gt;</span>Child text<span class="tag">&lt;/<span class="name">li</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"text"</span>&gt;</span></div><div class="line">  <span class="tag">&lt;/<span class="name">ul</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></div></pre></td></tr></table></figure></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> observer = <span class="keyword">new</span> MutationObserver(<span class="function"><span class="keyword">function</span>(<span class="params">mutations</span>) </span>&#123;</div><div class="line">  mutations.forEach(<span class="function"><span class="keyword">function</span>(<span class="params">mutation</span>) </span>&#123;</div><div class="line">    <span class="built_in">console</span>.log(mutation);</div><div class="line">  &#125;);</div><div class="line">&#125;);</div><div class="line"></div><div class="line">$(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</div><div class="line">  <span class="keyword">var</span> root = <span class="built_in">document</span>.getElementById(<span class="string">"root"</span>);</div><div class="line"></div><div class="line">  observer.observe(root, &#123;</div><div class="line">    childList: <span class="literal">true</span>,</div><div class="line">    characterData: <span class="literal">true</span>,</div><div class="line">    characterDataOldValue: <span class="literal">true</span>,</div><div class="line">    attributes: <span class="literal">true</span>,</div><div class="line">    attributeOldValue: <span class="literal">true</span>,</div><div class="line">    attributeFilter: [<span class="string">'data-new-attr'</span>],</div><div class="line">    subtree: <span class="literal">true</span></div><div class="line">  &#125;);</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<h3 id="Опции-в-правильном-порядке"><a href="#Опции-в-правильном-порядке" class="headerlink" title="Опции в правильном порядке"></a>Опции в правильном порядке</h3><h4 id="childList-true"><a href="#childList-true" class="headerlink" title="childList: true"></a>childList: true</h4><p>Срабатывает в случаях:<br><figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">document</span>.querySelector(<span class="string">'.parent'</span>).remove();</div><div class="line"><span class="built_in">document</span>.querySelector(<span class="string">'#root'</span>).removeChild(<span class="built_in">document</span>.querySelector(<span class="string">'.parent'</span>))</div><div class="line">jQuery(<span class="string">'#root'</span>).append(<span class="string">'&lt;div&gt;Appended&lt;/div&gt;'</span>);</div><div class="line">jQuery(<span class="string">'.parent'</span>).detach();</div></pre></td></tr></table></figure></p>
<p>Неожиданный результат:<br><figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">jQuery(<span class="string">'#root'</span>).text(<span class="string">'Text'</span>);</div></pre></td></tr></table></figure></p>
<p>Событие происходит дважды – оператор jQuery.text работает таким бразом, что текстовая нода сначала удаляется, после чего на её место вставляется новая. Поведение наблюдатся именно с опцией childList, при этом с одинокой опцией characterData от подобной замены текста событие не происходит вовсе.</p>
<h4 id="characterData-true"><a href="#characterData-true" class="headerlink" title="characterData: true"></a>characterData: true</h4><p>Срабатывает при изменении innerText, innerHTML, пользовательском редактировании элемента с атрибутом contenteditable.<br>Причём если innerText или innerHTML присваивается элементу с вложенными элементами, то событие не генерируется, вместо этого срабатывает опция childList потому, что происходит операция замены вложенных элементов на текстовый блок, а не изменение текстового блока.<br>Опция не отслеживает измененинияс деланные функцией jQuery.text(), потому что оператор работает методом удаления текстовой ноды и вставки на её место новой, что находится в области отслеживания childList. Вследствие этого нет никакого способа отслеживать только вставку и удаление текстовых нод.<br>Так же наблюдатель characterData не реагирует на изменение поля value элемента типа input.</p>
<h5 id="characterDataOldValue-true"><a href="#characterDataOldValue-true" class="headerlink" title="characterDataOldValue: true"></a>characterDataOldValue: true</h5><p>Используется только вместе с characterData. В объекте MutationRecord передаётся предыдущее значение текстовой ноды в поле oldValue.</p>
<h4 id="attributes-true"><a href="#attributes-true" class="headerlink" title="attributes: true"></a>attributes: true</h4><p>Отслеживает изменения атрибутов. Событие происходит в случаях:<br><figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">document</span>.querySelector(<span class="string">'#root'</span>).setAttribute(<span class="string">'data-new-attr'</span>, <span class="string">'Atribute added by Element.setAttribute'</span>);</div><div class="line">$(<span class="string">'#root'</span>).attr(<span class="string">'data-new-attr'</span>, <span class="string">'Atribute added by jQuery.attr'</span>);</div></pre></td></tr></table></figure></p>
<h5 id="attributeOldValue-true"><a href="#attributeOldValue-true" class="headerlink" title="attributeOldValue: true"></a>attributeOldValue: true</h5><p>Работает только с опцией attributes. В объекте MutationRecord передаётся предыдущее значение атрибута в поле oldValue.</p>
<h5 id="attributeFilter-‘data-new-attr’"><a href="#attributeFilter-‘data-new-attr’" class="headerlink" title="attributeFilter: [‘data-new-attr’]"></a>attributeFilter: [‘data-new-attr’]</h5><p>Работает только с опцией attributes. Массив - список атрибутов, которые необходимо отслеживать. Перечисленные в списке атрибуты будут проигнорированы наблюдателем.</p>
<h4 id="subtree-true"><a href="#subtree-true" class="headerlink" title="subtree: true"></a>subtree: true</h4><p>Эта опция увеличивает область наблюдения для всех перечисленных опций до всех вложенных элементов.<br>С “subtree: true” будут наблюдаться изменения во всём дереве элементов.<br>Область наблюдения без subtree:</p>
<figure class="highlight html"><table><tbody><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="tag"><span class="disabled">&lt;</span><span class="name"><span class="disabled">div</span></span> <span class="attr">id</span>=<span class="string">“root”</span> <span class="attr">data-custom-attribute</span>=<span class="string">“Root attribute”</span><span class="disabled">&gt;</span></span></div><div class="line">  Rooot text</div><div class="line">  <span class="tag">&lt;<span class="name">ul</span><span class="disabled"> <span class="attr">class</span>=<span class="string">“parent”</span> <span class="attr">data-custom-attribute</span>=<span class="string">“Parent attribute”</span></span>&gt;</span></div><div class="line"><span class="disabled">    <span class="tag">&lt;<span class="name">li</span> <span class="attr">class</span>=<span class="string">“child”</span> <span class="attr">data-custom-attribute</span>=<span class="string">“Child attribute”</span> <span class="attr">contenteditable</span>=<span class="string">“true”</span>&gt;</span>Child text<span class="tag">&lt;/<span class="name">li</span>&gt;</span></span></div><div class="line"><span class="disabled">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">“text”</span>&gt;</span></span></div><div class="line">  <span class="tag">&lt;/<span class="name">ul</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></div></pre></td></tr></tbody></table></figure>

<h4 id="Метод-takeRecords"><a href="#Метод-takeRecords" class="headerlink" title="Метод takeRecords"></a>Метод takeRecords</h4><p>Метод возвращает изменения, которые накопились в очереди наблюдателя. Работает синхронно, и нужен для того, чтобы получить изменения не в коллбэке, а не выходя в глобальную область видимости и не передавая поток выполнения другой функции.<br>В следующем случае takeRecords вернёт пустой массив:<br><figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> observer = <span class="keyword">new</span> MutationObserver(<span class="function"><span class="keyword">function</span>(<span class="params">mutations</span>) </span>&#123;</div><div class="line">  mutations.forEach(<span class="function"><span class="keyword">function</span>(<span class="params">mutation</span>) </span>&#123;</div><div class="line">    <span class="built_in">console</span>.log(<span class="string">'From observe'</span>, mutation);</div><div class="line">  &#125;);</div><div class="line">&#125;);</div><div class="line"></div><div class="line">$(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</div><div class="line">  observer.observe(root, &#123;</div><div class="line">    childList: <span class="literal">true</span></div><div class="line">  &#125;);</div><div class="line"></div><div class="line">  <span class="built_in">document</span>.querySelector(<span class="string">'.parent'</span>).remove();</div><div class="line"></div><div class="line">  setTimeout(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</div><div class="line">    <span class="keyword">var</span> mutations = observer.takeRecords();</div><div class="line">    <span class="built_in">console</span>.log(<span class="string">'From takeRecords'</span>, mutations);</div><div class="line">  &#125;, <span class="number">0</span>);</div><div class="line">&#125;);</div></pre></td></tr></table></figure></p>
<p>А в этом takeRecords вернёт изменение удаления и управление в коллбэк передано не будет:<br><figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> observer = <span class="keyword">new</span> MutationObserver(<span class="function"><span class="keyword">function</span>(<span class="params">mutations</span>) </span>&#123;</div><div class="line">  mutations.forEach(<span class="function"><span class="keyword">function</span>(<span class="params">mutation</span>) </span>&#123;</div><div class="line">    <span class="built_in">console</span>.log(<span class="string">'From observe'</span>, mutation);</div><div class="line">  &#125;);</div><div class="line">&#125;);</div><div class="line"></div><div class="line">$(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</div><div class="line">  observer.observe(root, &#123;</div><div class="line">    childList: <span class="literal">true</span></div><div class="line">  &#125;);</div><div class="line"></div><div class="line">  <span class="built_in">document</span>.querySelector(<span class="string">'.parent'</span>).remove();</div><div class="line"></div><div class="line">  <span class="keyword">var</span> mutations = observer.takeRecords();</div><div class="line">  <span class="built_in">console</span>.log(<span class="string">'From takeRecords'</span>, mutations);</div><div class="line">&#125;);</div></pre></td></tr></table></figure></p>
</div><div class="tags"><a href="/tags/WebAPI/">WebAPI</a> </div><div class="post__meta">15-07-2016</div></div><div class="post-nav"><a href="/introduction_to_reactive_programming_you_ve_been_missing/" class="post-nav__pre">&lt; Недостающее введение в реактивное программирование</a><a href="/mega_b2b/" class="post-nav__next">Сайт «Меги» для бизнеса &gt;</a></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">0000011111100000</div></div></div><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q || []).push(arguments)},i[r].l=1 * new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-81003165-1', 'auto');
ga('send', 'pageview');</script><script>(function (d, w, c) {
  (w[c] = w[c] || []).push(function () {
    try {
      w.yaCounter39479315 = new Ya.Metrika({
        id: 39479315,
        clickmap: true,
        trackLinks: true,
        accurateTrackBounce: true,
        webvisor: true
      });
    } catch (e) {
    }
  });

  var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () {
            n.parentNode.insertBefore(s, n);
          };
  s.type = "text/javascript";
  s.async = true;
  s.src = "https://mc.yandex.ru/metrika/watch.js";

  if (w.opera == "[object Opera]") {
    d.addEventListener("DOMContentLoaded", f, false);
  } else {
    f();
  }
})(document, window, "yandex_metrika_callbacks");</script></div></body></html>